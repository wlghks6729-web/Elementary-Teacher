<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ëˆ—ì…ˆ ì±—ë´‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .chat-container {
            max-width: 800px;
            height: 80vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            border: 1px solid #e2e8e0;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            animation: fadeIn 0.5s ease-in-out;
        }
        .bot-message {
            background-color: #e0e7ff;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .user-message {
            background-color: #d1fae5;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #e2e8e0;
            gap: 0.5rem;
        }
        input, button {
            border-radius: 0.75rem;
        }
        input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e1;
        }
        button {
            padding: 0.75rem 1.5rem;
            background-color: #4f46e5;
            color: white;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #4338ca;
        }
        .stage-select {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid #e2e8e0;
            justify-content: center;
        }
        .stage-button {
            padding: 0.75rem 1rem;
            background-color: #6ee7b7;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .stage-button:hover {
            background-color: #34d399;
        }
        .text-input {
            width: 100%;
        }
        .header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        .header-user-id {
            font-size: 0.875rem;
            color: #64748b;
        }
        .number-input-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .number-input-container input {
            width: 50px;
            text-align: center;
        }
        .start-button-container {
            padding: 1rem;
            display: flex;
            justify-content: center;
            border-top: 1px solid #e2e8e0;
        }
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .number-pad button {
            padding: 20px;
            font-size: 1.5em;
            background-color: #e2e8e0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .number-pad button:hover {
            background-color: #cbd5e1;
        }
        .llm-hint-button {
            background-color: #fcd34d;
            color: #92400e;
            font-weight: 600;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .llm-hint-button:hover {
            background-color: #fbbf24;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        .fade-out {
            animation: fadeOut 0.5s forwards;
        }
    </style>
</head>
<body>
    <div class="p-4 md:p-8 flex flex-col items-center min-h-screen">
        <div class="chat-container">
            <div class="header">
                <span class="header-title">ë‚˜ëˆ—ì…ˆ ì±—ë´‡</span>
                <span id="userIdDisplay" class="header-user-id">ìƒíƒœ: ë¡œë”© ì¤‘...</span>
            </div>
            <div id="messages" class="messages">
                <!-- Chat messages will be dynamically added here -->
            </div>
            <div id="input-container" class="input-area">
                <input type="text" id="userInput" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." class="text-input" disabled>
                <button id="sendBtn" disabled>ë³´ë‚´ê¸°</button>
            </div>
            <div id="start-button-container" class="start-button-container hidden">
                <button id="startButton" class="stage-button">ìƒˆ ë¬¸ì œ ì‹œì‘í•˜ê¸°</button>
            </div>
            <div id="number-input-start" class="input-area hidden">
                <div class="flex flex-col gap-2 w-full">
                    <p class="text-gray-600 font-semibold text-center">ë‚˜ëˆ—ì…ˆ ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 67 / 7)</p>
                    <div class="flex gap-2 justify-center items-center">
                        <input type="number" id="dividendInput" placeholder="ë‚˜ëˆ„ì–´ì§ˆ ìˆ˜" class="w-28 p-2 border rounded-md">
                        <span class="text-xl font-bold">/</span>
                        <input type="number" id="divisorInput" placeholder="ë‚˜ëˆ„ëŠ” ìˆ˜" class="w-28 p-2 border rounded-md">
                    </div>
                    <button id="problemStartBtn" class="stage-button mt-4">ë¬¸ì œ ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ë¡œê¹… ë ˆë²¨ ì„¤ì •
        setLogLevel('debug');

        // ì „ì—­ ë³€ìˆ˜ (ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ì œê³µë˜ëŠ” ë³€ìˆ˜ ì‚¬ìš©)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;
        let currentProblem = null;
        let step = 0;
        let isLlmGenerating = false; // LLM ìš”ì²­ ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸
        let isFirebaseReady = false; // Firebase ì´ˆê¸°í™” ì„±ê³µ ì—¬ë¶€ í”Œë˜ê·¸

        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const startButton = document.getElementById('startButton');
        const startButtonContainer = document.getElementById('start-button-container');
        const numberInputStart = document.getElementById('number-input-start');
        const problemStartBtn = document.getElementById('problemStartBtn');
        const dividendInput = document.getElementById('dividendInput');
        const divisorInput = document.getElementById('divisorInput');
        const inputContainer = document.getElementById('input-container');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // ==== Gemini API í˜¸ì¶œ í•¨ìˆ˜ ì‹œì‘ ====
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•œ Fetch í•¨ìˆ˜
        async function fetchWithExponentialBackoff(payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();

                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Gemini API í˜¸ì¶œ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼:", error);
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // 1. êµ¬ì²´ì ì¸ íŒíŠ¸ ìƒì„± (âœ¨ ë‚˜ëˆ”ë´‡ íŒ)
        async function generateHint(currentProblem, currentStep) {
            if (isLlmGenerating) return;
            isLlmGenerating = true;

            const problem = `${currentProblem.dividend} Ã· ${currentProblem.divisor}`;
            const question = currentProblem.steps[step - 1].text; 
            const expectedAnswer = currentStep.expectedNumber || currentStep.expectedTens || currentStep.expectedHundreds || currentStep.expectedModels.join(', ');
            
            const systemPrompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒì—ê²Œ ë‚˜ëˆ—ì…ˆì„ ê°€ë¥´ì¹˜ëŠ” ì¹œì ˆí•˜ê³  ê²©ë ¤í•˜ëŠ” ìˆ˜í•™ íŠœí„°(ë‚˜ëˆ”ë´‡)ì…ë‹ˆë‹¤. í•™ìƒì´ í‹€ë¦° ë¬¸ì œì˜ ë‹¨ê³„ë¥¼ ë³´ê³ , ì •ë‹µì„ ì§ì ‘ ì•Œë ¤ì£¼ì§€ ì•Šê³ , ë‹¤ìŒ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì„ ì°¾ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ íŒíŠ¸ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ì œê³µí•˜ì„¸ìš”. íŒíŠ¸ëŠ” ìˆ˜ ëª¨í˜•(ë°±ëª¨í˜•, ì‹­ëª¨í˜•, ì¼ëª¨í˜•)ì˜ ê°œë…ì„ ì‚¬ìš©í•˜ì—¬ ì„¤ëª…í•´ì•¼ í•©ë‹ˆë‹¤. ë‹µë³€ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;

            const userQuery = `í˜„ì¬ ë¬¸ì œ: ${problem}. ë°”ë¡œ ì´ì „ ì±—ë´‡ì˜ ì§ˆë¬¸: "${question}". ì´ ì§ˆë¬¸ì˜ ì •ë‹µì€ ${expectedAnswer}ì…ë‹ˆë‹¤. í•™ìƒì´ ì •ë‹µì„ ë§íˆì§€ ëª»í–ˆìœ¼ë¯€ë¡œ, ì´ ì •ë‹µì„ ìœ ì¶”í•  ìˆ˜ ìˆëŠ” 1ê°œì˜ êµ¬ì²´ì ì¸ íŒíŠ¸ ë¬¸ì¥ì„ ìƒì„±í•´ ì£¼ì„¸ìš”.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            addBotMessage('<div id="llm-hint-loading" class="text-sm text-gray-500 italic">âœ¨ ë‚˜ëˆ”ë´‡ íŒì„ ìƒê° ì¤‘...</div>');
            const loadingElement = document.getElementById('llm-hint-loading');

            try {
                const result = await fetchWithExponentialBackoff(payload);
                const hintText = result.candidates?.[0]?.content?.parts?.[0]?.text || "ì ì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ë³¼ê¹Œìš”?";
                
                if (loadingElement) {
                     // íŒíŠ¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ì„ ì‚¬ìš©ì ë©”ì‹œì§€ì²˜ëŸ¼ ë³€ê²½í•˜ì—¬ ë‹ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
                     loadingElement.parentElement.classList.remove('bot-message');
                     loadingElement.parentElement.classList.add('user-message', 'bg-yellow-100', 'text-gray-800');
                     loadingElement.innerHTML = `âœ¨ **ë‚˜ëˆ”ë´‡ íŒ:** ${hintText}`;
                     scrollToBottom();
                } else {
                    addBotMessage(`âœ¨ **ë‚˜ëˆ”ë´‡ íŒ:** ${hintText}`);
                }

            } catch (error) {
                console.error("íŒíŠ¸ ìƒì„± ì‹¤íŒ¨:", error);
                if (loadingElement) {
                    loadingElement.textContent = "íŒíŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”. í•˜ì§€ë§Œ ê´œì°®ì•„ìš”! ë‹¤ì‹œ ì‹œë„í•´ë´ìš”!";
                } else {
                    addBotMessage("íŒíŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”. í•˜ì§€ë§Œ ê´œì°®ì•„ìš”! ë‹¤ì‹œ ì‹œë„í•´ë´ìš”!");
                }
            } finally {
                isLlmGenerating = false;
            }
        }

        // 2. ìµœì¢… í”¼ë“œë°± ìƒì„± (âœ¨ ë‚˜ëˆ”ë´‡ ì½”ë©˜íŠ¸)
        async function generateFinalComment(dividend, divisor, quotient, remainder) {
            
            const problem = `${dividend} Ã· ${divisor}`;
            
            const systemPrompt = `ë‹¹ì‹ ì€ ì´ˆë“±í•™ìƒì—ê²Œ ë‚˜ëˆ—ì…ˆì„ ê°€ë¥´ì¹˜ëŠ” ì¹œì ˆí•˜ê³  ìœ ë¨¸ëŸ¬ìŠ¤í•œ ìˆ˜í•™ íŠœí„°(ë‚˜ëˆ”ë´‡)ì…ë‹ˆë‹¤. í•™ìƒì´ í‘¼ ë‚˜ëˆ—ì…ˆ ë¬¸ì œì˜ ê²°ê³¼ì™€ íŠ¹ì§•ì„ ë°”íƒ•ìœ¼ë¡œ, ì¹­ì°¬ê³¼ ê²©ë ¤ë¥¼ ë‹´ì€ 1~2ë¬¸ì¥ì˜ ìµœì¢… í”¼ë“œë°±ì„ í•œêµ­ì–´ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.`;

            const userQuery = `í•™ìƒì´ ë‚˜ëˆ—ì…ˆ ë¬¸ì œ ${problem}ë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤. ëª«ì€ ${quotient}ì´ê³  ë‚˜ë¨¸ì§€ëŠ” ${remainder}ì…ë‹ˆë‹¤. ì´ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì˜ ë…¸ë ¥ì— ëŒ€í•´ ì¹­ì°¬í•˜ê³  ê²©ë ¤í•˜ëŠ” ìµœì¢… ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”. (ì˜ˆì‹œ: ë‚˜ë¨¸ì§€ê°€ 0ì´ë‹ˆ ê¹”ë”í•˜ê²Œ ì„±ê³µí–ˆë„¤ìš”!)`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // ì™„ë£Œ ë©”ì‹œì§€ ì§í›„ì— LLM í˜¸ì¶œ
            try {
                const result = await fetchWithExponentialBackoff(payload);
                const commentText = result.candidates?.[0]?.content?.parts?.[0]?.text || "ìˆ˜ê³ í–ˆì–´ìš”! ì •ë§ ë©‹ì§„ í•™ìŠµ íƒœë„ì˜ˆìš”!";
                addBotMessage(`<div class="text-lg font-bold text-indigo-700">ğŸ‰ âœ¨ ë‚˜ëˆ”ë´‡ ì½”ë©˜íŠ¸:</div><div class="text-base">${commentText}</div>`);
            } catch (error) {
                console.error("ìµœì¢… ì½”ë©˜íŠ¸ ìƒì„± ì‹¤íŒ¨:", error);
                addBotMessage(`ìˆ˜ê³ í–ˆì–´ìš”! ì •ë§ ë©‹ì§„ í•™ìŠµ íƒœë„ì˜ˆìš”!`);
            }
        }
        // ==== Gemini API í˜¸ì¶œ í•¨ìˆ˜ ë ====


        // ì£¼ì–´ì§„ ë‚˜ëˆ—ì…ˆ ë¬¸ì œì— ëŒ€í•œ ëŒ€í™” ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± (ì—„ê²©í•œ ë¡œì§ ìœ ì§€)
        function createScenario(dividend, divisor) {
            const scenario = [];
            const isThreeDigit = dividend >= 100;

            if (isThreeDigit) {
                const hundreds = Math.floor(dividend / 100);
                const tens = Math.floor((dividend % 100) / 10);
                const ones = dividend % 10;
                
                // ë°±ëª¨í˜•, ì‹­ëª¨í˜•, ì¼ëª¨í˜• ê°œìˆ˜ ë¬»ê¸°
                scenario.push({ type: 'bot', text: `ì•ˆë…•! ë‚˜ëŠ” ë‚˜ëˆ—ì…ˆì„ ë„ì™€ì£¼ëŠ” ë‚˜ëˆ”ë´‡ì´ì•¼. í•¨ê»˜ ${dividend} Ã· ${divisor}ë¥¼ ê³„ì‚°í•´ë³¼ê¹Œ? ë¨¼ì € ${dividend}ì„ ìˆ˜ ëª¨í˜•ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´, ë°±ëª¨í˜•, ì‹­ëª¨í˜•, ì¼ëª¨í˜•ì´ ê°ê° ëª‡ ê°œì”© í•„ìš”í• ê¹Œ?` });
                scenario.push({
                    type: 'user',
                    correctType: 'blockCount',
                    expectedHundreds: hundreds,
                    expectedTens: tens,
                    expectedOnes: ones
                });
                
                let quotientHundreds = 0; 
                let remainderHundreds = 0;
                let totalTens = 0;

                // ë°±ëª¨í˜• ë‚˜ëˆ„ê¸°
                if (hundreds >= divisor) {
                    quotientHundreds = Math.floor(hundreds / divisor); 
                    remainderHundreds = hundreds % divisor;

                    scenario.push({ type: 'bot', text: `ì¢‹ì•„. ê·¸ëŸ¼ ë°±ëª¨í˜• ${hundreds}ê°œë¥¼ ${divisor}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì£¼ë©´ í•œ ëª…ë‹¹ ëª‡ ê°œì”© ê°€ì§ˆ ìˆ˜ ìˆì„ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientHundreds });
                    
                    // ë‚˜ëˆ„ì–´ ì¤€ ì´ ë°±ëª¨í˜• ê°œìˆ˜ ë¬»ëŠ” ë‹¨ê³„
                    scenario.push({ type: 'bot', text: `ë”©ë™ëŒ•! ê·¸ëŸ¼ ${divisor}ëª…ì—ê²Œ ë°±ëª¨í˜•ì„ ${quotientHundreds}ê°œì”© ë‚˜ëˆ„ì–´ì£¼ë©´, ìš°ë¦¬ê°€ ì‚¬ìš©í•œ ë°±ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ? ( ${divisor}ëª… x ${quotientHundreds}ê°œ )` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientHundreds * divisor });

                    scenario.push({ type: 'bot', text: `ë§ì•„! ê·¸ëŸ¼ ë‚¨ëŠ” ë°±ëª¨í˜•ì€ ëª‡ ê°œì¼ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'numberOrText', expectedNumber: remainderHundreds, correctText: ['ì—†ì–´ìš”', '0ê°œ'] });

                    totalTens = remainderHundreds * 10 + tens;
                    
                    // --- ë°±ëª¨í˜•ì´ ë‚¨ëŠ” ê²½ìš°, ì‹­ëª¨í˜•ìœ¼ë¡œ ë³€í™˜ ë° í•©ì‚° ê³¼ì • ---
                    if (remainderHundreds > 0) {
                        const convertedTens = remainderHundreds * 10;
                        
                        // 1. ë‚¨ì€ ë°±ëª¨í˜•ì„ ì‹­ëª¨í˜•ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì§ˆë¬¸
                        scenario.push({ type: 'bot', text: `ë§ì•„! ë‚¨ì€ ë°±ëª¨í˜• ${remainderHundreds}ê°œëŠ” ${divisor}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì¤„ ìˆ˜ ì—†ìœ¼ë‹ˆ, ì‹­ëª¨í˜•ìœ¼ë¡œ ë°”ê¾¸ì–´ì£¼ì. ë°±ëª¨í˜• 1ê°œëŠ” ì‹­ëª¨í˜• 10ê°œì™€ ê°™ìœ¼ë‹ˆ, ë°±ëª¨í˜• ${remainderHundreds}ê°œëŠ” ì‹­ëª¨í˜• ëª‡ ê°œì™€ ê°™ì„ê¹Œ?` });
                        scenario.push({ type: 'user', correctType: 'number', expectedNumber: convertedTens });
    
                        // 2. ìƒˆë¡œ ë°”ê¾¼ ì‹­ëª¨í˜•ê³¼ ì›ë˜ ì‹­ëª¨í˜•ì„ í•©ì¹˜ëŠ” ì§ˆë¬¸
                        scenario.push({ type: 'bot', text: `ìµœê³ ì•¼! ê·¸ëŸ¼ ìƒˆë¡œ ë°”ê¾¼ ì‹­ëª¨í˜• ${convertedTens}ê°œì™€ ì›ë˜ ìˆë˜ ì‹­ëª¨í˜• ${tens}ê°œë¥¼ í•©ì¹˜ë©´, ì‹­ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œê°€ ë ê¹Œ?` });
                        scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalTens });
                    }
                    // --- ë°±ëª¨í˜• ê³¼ì • ë ---

                } else { // ë°±ëª¨í˜•ì´ ë‚˜ëˆ„ëŠ” ìˆ˜ë³´ë‹¤ ì‘ì€ ê²½ìš° (ì˜ˆ: 100 Ã· 5)
                    scenario.push({ type: 'bot', text: `ë°±ëª¨í˜• ${hundreds}ê°œëŠ” ${divisor}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì¤„ ìˆ˜ ì—†ìœ¼ë‹ˆ, ì‹­ëª¨í˜•ìœ¼ë¡œ ë°”ê¿”ì£¼ì. ë°±ëª¨í˜• ${hundreds}ê°œëŠ” ì‹­ëª¨í˜• ëª‡ ê°œì™€ ê°™ì„ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: hundreds * 10 });

                    scenario.push({ type: 'bot', text: `ì•„ì£¼ ì˜í–ˆì–´! ê·¸ëŸ¼ ìƒˆë¡œ ë°”ê¾¼ ì‹­ëª¨í˜• ${hundreds * 10}ê°œì™€ ì›ë˜ ìˆë˜ ì‹­ëª¨í˜• ${tens}ê°œë¥¼ í•©ì¹˜ë©´, ì‹­ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œê°€ ë ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: hundreds * 10 + tens });

                    totalTens = hundreds * 10 + tens;
                }
                
                const quotientTens = Math.floor(totalTens / divisor);
                const remainderTens = totalTens % divisor;

                // ì‹­ëª¨í˜• ë‚˜ëˆ„ê¸°
                if (totalTens > 0) {
                    scenario.push({ type: 'bot', text: `ì•„ì£¼ ì˜í–ˆì–´! ê·¸ëŸ¼ ì‹­ëª¨í˜• ${totalTens}ê°œë¥¼ ${divisor}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì£¼ë©´ í•œ ëª…ë‹¹ ëª‡ ê°œì”© ê°€ì§ˆ ìˆ˜ ìˆì„ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens });

                    scenario.push({ type: 'bot', text: `ë”©ë™ëŒ•! ê·¸ëŸ¼ ${divisor}ëª…ì—ê²Œ ì‹­ëª¨í˜•ì„ ${quotientTens}ê°œì”© ë‚˜ëˆ„ì–´ì£¼ë©´, ìš°ë¦¬ê°€ ì‚¬ìš©í•œ ì‹­ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens * divisor });
                
                    scenario.push({ type: 'bot', text: `ì˜í–ˆì–´! ê·¸ëŸ¼ ë‚¨ëŠ” ì‹­ëª¨í˜•ì€ ëª‡ ê°œì¼ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'numberOrText', expectedNumber: remainderTens, correctText: ['ì—†ì–´ìš”', '0ê°œ'] });
                } else if (quotientHundreds > 0 && totalTens === 0) {
                    scenario.push({ type: 'bot', text: `ë‚˜ëˆ„ì–´ ì¤„ ì‹­ëª¨í˜•ì´ ì—†ìœ¼ë‹ˆ, ëª«ì˜ ì‹­ì˜ ìë¦¬ëŠ” 0ì´ ë˜ê² êµ¬ë‚˜. ì´ì œ ì¼ëª¨í˜•ì„ ê°€ì§€ê³  ë‚˜ëˆ„ì–´ ë³¼ê¹Œ?` });
                } else {
                     scenario.push({ type: 'bot', text: `ì‹­ëª¨í˜•ì´ ì—†ìœ¼ë‹ˆ, ì´ì œ ì¼ëª¨í˜•ì„ ê°€ì§€ê³  ë‚˜ëˆ„ì–´ ë³¼ê¹Œ?` });
                }

                const convertedOnes = remainderTens * 10;
                const totalOnes = convertedOnes + ones;
                
                // ë‚¨ì€ ì‹­ëª¨í˜•ì„ ì¼ëª¨í˜•ìœ¼ë¡œ ë°”ê¾¸ëŠ” ê³¼ì •
                if(remainderTens > 0) {
                    // 1. ë‚¨ì€ ì‹­ëª¨í˜•ì„ ì¼ëª¨í˜•ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì§ˆë¬¸ ì¶”ê°€
                    scenario.push({ type: 'bot', text: `ë§ì•„! ë‚¨ì€ ì‹­ëª¨í˜• ${remainderTens}ê°œëŠ” ì¼ëª¨í˜•ìœ¼ë¡œ ë°”ê¿”ì£¼ì. ì‹­ëª¨í˜• 1ê°œëŠ” ì¼ëª¨í˜• 10ê°œì™€ ê°™ìœ¼ë‹ˆ, ì‹­ëª¨í˜• ${remainderTens}ê°œëŠ” ì¼ëª¨í˜• ëª‡ ê°œì™€ ê°™ì„ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: convertedOnes });
                    
                    // 2. ìƒˆë¡œ ë°”ê¾¼ ì¼ëª¨í˜•ê³¼ ì›ë˜ ì¼ëª¨í˜•ì„ í•©ì¹˜ëŠ” ì§ˆë¬¸
                    scenario.push({ type: 'bot', text: `ìµœê³ ì•¼! ê·¸ëŸ¼ ë°”ê¿”ì¤€ ì¼ëª¨í˜• ${convertedOnes}ê°œì™€ ì›ë˜ ìˆë˜ ì¼ëª¨í˜• ${ones}ê°œë¥¼ í•©ì¹˜ë©´, ì¼ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œê°€ ë ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalOnes });

                } else if (totalTens > 0 && remainderTens === 0) {
                    // ì‹­ëª¨í˜•ì´ ë”± ë–¨ì–´ì ¸ì„œ ë‚¨ì€ ì‹­ëª¨í˜•ì´ 0ì´ê³ , ì›ë˜ ì‹­ëª¨í˜•ì´ 0ì´ ì•„ë‹ˆì—ˆë˜ ê²½ìš° (ex: 400 / 4)
                    scenario.push({ type: 'bot', text: `ë‚¨ì€ ì‹­ëª¨í˜•ì€ ì—†ìœ¼ë‹ˆ, ì›ë˜ ìˆë˜ ì¼ëª¨í˜• ${ones}ê°œë¥¼ ê°€ì§€ê³  ê³„ì† í’€ì–´ë³´ì. ì¼ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: ones });
                } else if (totalTens === 0) {
                    // ì‹­ëª¨í˜•ì´ ì²˜ìŒë¶€í„° 0ê°œì˜€ë˜ ê²½ìš° (ex: 108 / 4, 08 / 4)
                    scenario.push({ type: 'bot', text: `ì¼ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalOnes });
                }
                
                const quotientOnes = Math.floor(totalOnes / divisor);
                const remainderOnes = totalOnes % divisor;

                scenario.push({ type: 'bot', text: `ì™„ë²½í•´! ì´ì œ ì¼ëª¨í˜• ${totalOnes}ê°œë¥¼ ${divisor}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì£¼ë©´ í•œ ëª…ë‹¹ ëª‡ ê°œì”© ê°€ì§€ê²Œ ë ê¹Œ?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes });
                
                // ì‚¬ìš©í•œ ì¼ëª¨í˜• ì´ ê°œìˆ˜ ì§ˆë¬¸ - ì—„ê²©í•œ ë¡œì§ ìœ ì§€ (ëª« x ë‚˜ëˆ„ëŠ” ìˆ˜ë§Œ ì •ë‹µ)
                scenario.push({ type: 'bot', text: `ëŒ€ë‹¨í•´! ê·¸ëŸ¼ ${divisor}ëª…ì—ê²Œ ì¼ëª¨í˜•ì„ ${quotientOnes}ê°œì”© ë‚˜ëˆ„ì–´ì£¼ë©´, ìš°ë¦¬ê°€ ì‚¬ìš©í•œ ì¼ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes * divisor });

                scenario.push({ type: 'bot', text: `ë§ì•„. ê·¸ëŸ¼ ë‚¨ëŠ” ì¼ëª¨í˜•ì€ ëª‡ ê°œì¼ê¹Œ?` });
                scenario.push({ type: 'user', correctType: 'numberOrText', expectedNumber: remainderOnes, correctText: ['ì—†ì–´ìš”', '0ê°œ'] });

                const finalQuotient = parseInt(quotientHundreds.toString() + quotientTens.toString() + quotientOnes.toString());
                
                // Final question logic - ëª¨í˜• ê°œìˆ˜ ë¦¬ìŠ¤íŠ¸ ì •ë¦¬
                let expectedModels = []; 
                let modelQuestionText = "ë°±ëª¨í˜•, ì‹­ëª¨í˜•, ì¼ëª¨í˜•ì„ ê°ê° ëª‡ ê°œì”© ë°›ì•˜ë‚˜ìš”?";
                
                if(quotientHundreds > 0) expectedModels.push(quotientHundreds);
                // ëª«ì´ 100ì˜ ìë¦¬ë¶€í„° ì‹œì‘í•  ê²½ìš°, ì‹­ì˜ ìë¦¬ê°€ 0ì´ì–´ë„ í¬í•¨í•´ì•¼ í•¨ (ì˜ˆ: 408/4 -> 102)
                if(quotientTens > 0 || (quotientHundreds > 0 && totalTens === 0) ) expectedModels.push(quotientTens);
                if(quotientOnes >= 0) expectedModels.push(quotientOnes); 

                // ëª«ì´ 100ë³´ë‹¤ ì‘ì€ ê²½ìš° (e.g. 98/4 -> 24)
                if (finalQuotient < 100) {
                    modelQuestionText = "ì‹­ëª¨í˜•ê³¼ ì¼ëª¨í˜•ì„ ê°ê° ëª‡ ê°œì”© ë°›ì•˜ë‚˜ìš”?";
                    // expectedModelsì—ì„œ ë°±ì˜ ìë¦¬ 0ì„ ì œê±°
                    if (expectedModels[0] === 0) expectedModels.shift(); 
                }

                scenario.push({ type: 'bot', text: `ì™„ë²½í•´! ì´ì œ ë§ˆì§€ë§‰ì´ì•¼. í•œ ì‚¬ëŒì´ ${modelQuestionText}` });
                scenario.push({
                    type: 'user',
                    correctType: 'finalModelCount', 
                    expectedModels: expectedModels,
                    isFinalQuestion: true
                });

                scenario.push({ type: 'bot', text: `ë°”ë¡œ ê·¸ê±°ì•¼! ê·¸ëŸ¼ í•œ ì‚¬ëŒì´ ë°›ì€ ê²ƒì€ ëª¨ë‘ í•©ì³ì„œ ì–¼ë§ˆì¼ê¹Œ?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: finalQuotient, isFinalQuestion: true });
                scenario.push({ type: 'bot', text: `ì •ë‹µì´ì•¼! ê·¸ë˜ì„œ ${dividend} Ã· ${divisor}ì˜ ëª«ì€ ${finalQuotient}ì´ê³  ë‚˜ë¨¸ì§€ëŠ” ${remainderOnes}ì´ ëœë‹¨ë‹¤. ë„ˆ ì •ë§ ëŒ€ë‹¨í•´!` });

                return { dividend, divisor, quotient: finalQuotient, remainder: remainderOnes, steps: scenario };
            }

            // ë‘ ìë¦¬ ìˆ˜ ë‚˜ëˆ—ì…ˆ ë¡œì§
            const tens = Math.floor(dividend / 10);
            const ones = dividend % 10;
            scenario.push({ type: 'bot', text: `ì•ˆë…•! ë‚˜ëŠ” ë‚˜ëˆ—ì…ˆì„ ë„ì™€ì£¼ëŠ” ë‚˜ëˆ”ë´‡ì´ì•¼. í•¨ê»˜ ${dividend} Ã· ${divisor}ë¥¼ ê³„ì‚°í•´ë³¼ê¹Œ? ë¨¼ì € ${dividend}ì„ ìˆ˜ ëª¨í˜•ìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ì‹­ëª¨í˜•ê³¼ ì¼ëª¨í˜•ì´ ê°ê° ëª‡ ê°œì”© í•„ìš”í• ê¹Œ?` });
            
            scenario.push({
                type: 'user',
                correctType: 'blockCount',
                expectedTens: tens,
                expectedOnes: ones
            });

            scenario.push({ type: 'bot', text: `ë§ì•„! ê·¸ëŸ¼ ì´ ì‹­ëª¨í˜• ${tens}ê°œì™€ ì¼ëª¨í˜• ${ones}ê°œë¥¼ ëª‡ ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì£¼ì–´ì•¼ í• ê¹Œ?` });
            
            scenario.push({ type: 'user', correctType: 'number', expectedNumber: divisor });
            scenario.push({ type: 'bot', text: `ì •í™•í•´! ê·¸ëŸ¼ ë¨¼ì € ì‹­ëª¨í˜• ${tens}ê°œë¥¼ ${divisor}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì£¼ë©´ í•œ ëª…ë‹¹ ëª‡ ê°œì”© ê°€ì§ˆ ìˆ˜ ìˆì„ê¹Œ?` });
            
            let currentTens = tens;
            const quotientTens = Math.floor(currentTens / divisor);
            const remainderTens = currentTens % divisor;

            scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens });

            // ë‚˜ëˆ„ì–´ ì¤€ ì´ ì‹­ëª¨í˜• ê°œìˆ˜ ë¬»ëŠ” ë‹¨ê³„
            scenario.push({ type: 'bot', text: `ë”©ë™ëŒ•! ê·¸ëŸ¼ ${divisor}ëª…ì—ê²Œ ì‹­ëª¨í˜•ì„ ${quotientTens}ê°œì”© ë‚˜ëˆ„ì–´ì£¼ë©´, ìš°ë¦¬ê°€ ì‚¬ìš©í•œ ì‹­ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ? ( ${divisor}ëª… x ${quotientTens}ê°œ )` });
            scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens * divisor });

            const remainderTensQuestion = (remainderTens === 0) ? `ì•„ì£¼ ì˜í–ˆì–´! ë‚¨ëŠ” ì‹­ëª¨í˜•ì´ ì—†ë„¤ìš”!` : `ì•„ì£¼ ì˜í–ˆì–´! ê·¸ëŸ¼ ì›ë˜ ìˆë˜ ì‹­ëª¨í˜• ${tens}ê°œ ì¤‘ì—ì„œ ${quotientTens * divisor}ê°œë¥¼ ë‚˜ëˆ„ì–´ì£¼ì—ˆìœ¼ë‹ˆ, ë‚¨ëŠ” ì‹­ëª¨í˜•ì€ ëª‡ ê°œì¼ê¹Œ?`;
            scenario.push({ type: 'bot', text: remainderTensQuestion });
            
            if (remainderTens > 0) {
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: remainderTens });
            }

            const convertedOnes = remainderTens * 10;
            const totalOnes = convertedOnes + ones;
            
            if(remainderTens === 0) {
                scenario.push({ type: 'bot', text: `ë‚¨ì€ ì‹­ëª¨í˜•ì€ ì—†ìœ¼ë‹ˆ, ì›ë˜ ìˆë˜ ì¼ëª¨í˜• ${ones}ê°œë¥¼ ê°€ì§€ê³  ê³„ì† í’€ì–´ë³´ì. ì¼ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: ones });
            } else { // remainderTens > 0 ì¸ ê²½ìš°
                // 1. ë‚¨ì€ ì‹­ëª¨í˜•ì„ ì¼ëª¨í˜•ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì§ˆë¬¸ ì¶”ê°€
                scenario.push({ type: 'bot', text: `ë§ì•„! ë‚¨ì€ ì‹­ëª¨í˜• ${remainderTens}ê°œëŠ” ì¼ëª¨í˜•ìœ¼ë¡œ ë°”ê¿”ì£¼ì. ì‹­ëª¨í˜• 1ê°œëŠ” ì¼ëª¨í˜• 10ê°œì™€ ê°™ìœ¼ë‹ˆ, ì‹­ëª¨í˜• ${remainderTens}ê°œëŠ” ì¼ëª¨í˜• ëª‡ ê°œì™€ ê°™ì„ê¹Œ?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: convertedOnes });
                
                // 2. ìƒˆë¡œ ë°”ê¾¼ ì¼ëª¨í˜•ê³¼ ì›ë˜ ì¼ëª¨í˜•ì„ í•©ì¹˜ëŠ” ì§ˆë¬¸
                scenario.push({ type: 'bot', text: `ìµœê³ ì•¼! ê·¸ëŸ¼ ë°”ê¿”ì¤€ ì¼ëª¨í˜• ${convertedOnes}ê°œì™€ ì›ë˜ ìˆë˜ ì¼ëª¨í˜• ${ones}ê°œë¥¼ í•©ì¹˜ë©´, ì¼ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œê°€ ë ê¹Œ?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalOnes });
            }
            
            const quotientOnes = Math.floor(totalOnes / divisor);
            const remainderOnes = totalOnes % divisor;
            
            scenario.push({ type: 'bot', text: `ì™„ë²½í•´! ì´ì œ ì¼ëª¨í˜• ${totalOnes}ê°œë¥¼ ${divisor}ëª…ì—ê²Œ ë˜‘ê°™ì´ ë‚˜ëˆ„ì–´ ì£¼ë©´ í•œ ëª…ë‹¹ ëª‡ ê°œì”© ê°€ì§€ê²Œ ë ê¹Œ?` });

            scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes });
            scenario.push({ type: 'bot', text: `ëŒ€ë‹¨í•´! ê·¸ëŸ¼ ${divisor}ëª…ì—ê²Œ ì¼ëª¨í˜•ì„ ${quotientOnes}ê°œì”© ë‚˜ëˆ„ì–´ì£¼ë©´, ìš°ë¦¬ê°€ ì‚¬ìš©í•œ ì¼ëª¨í˜•ì€ ëª¨ë‘ ëª‡ ê°œì¼ê¹Œ?` });
            
            scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes * divisor });
            scenario.push({ type: 'bot', text: `ë§ì•„. ê·¸ëŸ¼ ë‚¨ëŠ” ì¼ëª¨í˜•ì€ ëª‡ ê°œì¼ê¹Œ?` });
            
            scenario.push({ type: 'user', correctType: 'numberOrText', expectedNumber: remainderOnes, correctText: ['ì—†ì–´ìš”', '0ê°œ'] });
            
            const finalQuotient = parseInt(quotientTens.toString() + quotientOnes.toString());
            
            // ìµœì¢… ì§ˆë¬¸ ë¬¸êµ¬ ìˆ˜ì •
            scenario.push({ type: 'bot', text: `ì™„ë²½í•´! ì´ì œ ë§ˆì§€ë§‰ì´ì•¼. í•œ ì‚¬ëŒì´ ì‹­ëª¨í˜•ê³¼ ì¼ëª¨í˜•ì„ ê°ê° ëª‡ ê°œì”© ë°›ì•˜ë‚˜ìš”?` });
            scenario.push({
                type: 'user',
                correctType: 'finalModelCount', 
                expectedModels: [quotientTens, quotientOnes],
                isFinalQuestion: true
            });
            scenario.push({ type: 'bot', text: `ë°”ë¡œ ê·¸ê±°ì•¼! ê·¸ëŸ¼ í•œ ì‚¬ëŒì´ ë°›ì€ ê²ƒì€ ëª¨ë‘ í•©ì³ì„œ ì–¼ë§ˆì¼ê¹Œ?` });
            
            scenario.push({ type: 'user', correctType: 'number', expectedNumber: finalQuotient, isFinalQuestion: true });
            scenario.push({ type: 'bot', text: `ì •ë‹µì´ì•¼! ê·¸ë˜ì„œ ${dividend} Ã· ${divisor}ì˜ ëª«ì€ ${finalQuotient}ì´ê³  ë‚˜ë¨¸ì§€ëŠ” ${remainderOnes}ì´ ëœë‹¨ë‹¤. ë„ˆ ì •ë§ ëŒ€ë‹¨í•´!` });

            return { dividend, divisor, quotient: finalQuotient, remainder: remainderOnes, steps: scenario };
        }

        async function initApp() {
            // Firebase Config ìœ íš¨ì„± ê²€ì‚¬: êµ¬ì„± ì •ë³´ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™” ì¤‘ë‹¨
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase Configuration is missing. Cannot initialize Firebase. Using local state.");
                userIdDisplay.textContent = 'ìƒíƒœ: ê¸°ë¡ ì €ì¥ ë¶ˆê°€ (ì‹œìŠ¤í…œ ì˜¤ë¥˜)';
                addBotMessage('ğŸš¨ **ì‹œìŠ¤í…œ ì˜¤ë¥˜:** í•™ìŠµ ê¸°ë¡ ì €ì¥ì†Œ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ê±±ì • ë§ˆì„¸ìš”! ì±—ë´‡ì€ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                isFirebaseReady = false;
                showStartScreen();
                return; 
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseReady = true;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // ì‚¬ìš©ì IDë¥¼ ì§§ê²Œ í‘œì‹œ
                        userIdDisplay.textContent = `ì‚¬ìš©ì ID: ${userId.substring(0, 8)}...`;
                        await loadChatState();
                        showStartScreen();
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                userIdDisplay.textContent = 'ìƒíƒœ: ê¸°ë¡ ì €ì¥ ë¶ˆê°€ (ì´ˆê¸°í™” ì˜¤ë¥˜)';
                addBotMessage('ğŸš¨ **ì´ˆê¸°í™” ì‹¤íŒ¨:** Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í•™ìŠµ ê¸°ë¡ ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ì±—ë´‡ì€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                isFirebaseReady = false;
                // ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ ì±—ë´‡ ì‚¬ìš©ì€ ê°€ëŠ¥í•˜ë„ë¡ ì‹œì‘ í™”ë©´ í‘œì‹œ
                showStartScreen(); 
            }
        }

        async function saveChatState() {
            if (!isFirebaseReady || !userId) return;
            // Firestoreì— ìƒíƒœ ì €ì¥ (Private Data)
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/chatState/state`);
            try {
                await setDoc(userDocRef, {
                    currentProblem: currentProblem,
                    step: step,
                    messages: messagesContainer.innerHTML
                });
            } catch (error) {
                console.error("ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", error);
            }
        }

        async function loadChatState() {
            if (!isFirebaseReady || !userId) {
                // Firebaseê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‚¬ìš©ì IDê°€ ì—†ëŠ” ê²½ìš° ìƒˆ ì±„íŒ… ì‹œì‘
                addBotMessage('ì•ˆë…•í•˜ì„¸ìš”! ë‚˜ëˆ—ì…ˆ ì±—ë´‡, ë‚˜ëˆ”ë´‡ì´ì—ìš”. í•¨ê»˜ ì¬ë¯¸ìˆëŠ” ë‚˜ëˆ—ì…ˆ ê³µë¶€ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?');
                return;
            }
            // Firestoreì—ì„œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/chatState/state`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentProblem = data.currentProblem;
                    step = data.step;
                    messagesContainer.innerHTML = data.messages;
                    scrollToBottom();
                    if (currentProblem && step < currentProblem.steps.length) {
                        sendNextMessage();
                    } else {
                        showStartScreen();
                    }
                } else {
                    addBotMessage('ì•ˆë…•í•˜ì„¸ìš”! ë‚˜ëˆ—ì…ˆ ì±—ë´‡, ë‚˜ëˆ”ë´‡ì´ì—ìš”. í•¨ê»˜ ì¬ë¯¸ìˆëŠ” ë‚˜ëˆ—ì…ˆ ê³µë¶€ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?');
                }
            } catch (error) {
                console.error("ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                addBotMessage('ì´ì „ í•™ìŠµ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆì–´ìš”. ìƒˆë¡œìš´ í•™ìŠµì„ ì‹œì‘í•´ë³¼ê¹Œìš”?');
            }
        }

        function addBotMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message bot-message';
            msgDiv.innerHTML = text;
            messagesContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';
            msgDiv.textContent = text;
            messagesContainer.appendChild(msgDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function enableInput() {
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        function disableInput() {
            userInput.disabled = true;
            sendBtn.disabled = true;
        }

        function showStartScreen() {
            inputContainer.classList.add('hidden');
            startButtonContainer.classList.remove('hidden');
            numberInputStart.classList.remove('hidden');
        }

        function hideStartScreen() {
            inputContainer.classList.remove('hidden');
            startButtonContainer.classList.add('hidden');
            numberInputStart.classList.add('hidden');
        }

        function startProblem(problem) {
            messagesContainer.innerHTML = '';
            currentProblem = problem;
            step = 0;
            hideStartScreen();
            sendNextMessage();
        }

        function sendNextMessage() {
            while (currentProblem && step < currentProblem.steps.length) {
                const currentStep = currentProblem.steps[step];
                if (currentStep.type === 'bot') {
                    addBotMessage(currentStep.text);
                    step++;
                } else {
                    // ì‚¬ìš©ì ì…ë ¥ ë‹¨ê³„ì—ì„œëŠ” íŒíŠ¸ ë²„íŠ¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                    addHintButton();
                    enableInput();
                    saveChatState(); // Firebase readyì¼ ë•Œë§Œ ì €ì¥ ì‹œë„
                    return;
                }
            }
            // ëª¨ë“  ë‹¨ê³„ ì™„ë£Œ í›„ ìµœì¢… ì½”ë©˜íŠ¸ ìš”ì²­
            if (currentProblem) {
                generateFinalComment(currentProblem.dividend, currentProblem.divisor, currentProblem.quotient, currentProblem.remainder);
            }
            addBotMessage('ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆì–´ìš”! ìƒˆë¡œìš´ ë¬¸ì œë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?');
            showStartScreen();
            saveChatState(); // Firebase readyì¼ ë•Œë§Œ ì €ì¥ ì‹œë„
        }

        function addHintButton() {
            // ì´ë¯¸ íŒíŠ¸ ë²„íŠ¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìˆë‹¤ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            if (document.getElementById('llmHintButton')) return; 

            const btn = document.createElement('button');
            btn.id = 'llmHintButton';
            btn.className = 'llm-hint-button';
            btn.textContent = 'âœ¨ ë‚˜ëˆ”ë´‡ íŒ ë°›ê¸° (ë„ì›€ë§)';
            btn.onclick = () => {
                if (!currentProblem || step >= currentProblem.steps.length) return;
                const currentStep = currentProblem.steps[step];
                generateHint(currentProblem, currentStep);
            };

            const lastMessage = messagesContainer.lastElementChild;
            // ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ë´‡ ë©”ì‹œì§€ì¸ ê²½ìš°ì—ë§Œ íŒíŠ¸ ë²„íŠ¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            if (lastMessage && lastMessage.classList.contains('bot-message')) {
                lastMessage.appendChild(btn);
            }
        }
        
        function removeHintButton() {
            const btn = document.getElementById('llmHintButton');
            if (btn) btn.remove();
        }


        function checkAnswer(answer) {
            if (!currentProblem || step >= currentProblem.steps.length) {
                return;
            }
            
            const currentStep = currentProblem.steps[step];
            // ë´‡ ì „ìš© ë‹¨ê³„ ê±´ë„ˆë›°ê¸°
            if (currentStep.type === 'bot') {
              step++;
              sendNextMessage();
              return;
            }

            let isCorrect = false;
            const normalizedAnswer = answer.toLowerCase().trim();
            // ìˆ«ìë§Œ ì¶”ì¶œ (ì˜ˆ: '10ê°œ' -> 10)
            const numbers = normalizedAnswer.match(/\d+/g);

            if (currentStep.correctType === 'blockCount') {
                // ì‹­ëª¨í˜•/ë°±ëª¨í˜•/ì¼ëª¨í˜• ê°œìˆ˜ í™•ì¸ ë¡œì§ (ì´ˆê¸°)
                if (numbers) {
                    let expected;
                    let correctCount = 0;
                    let totalExpected = 0;

                    if (currentStep.expectedHundreds !== undefined) {
                        expected = [currentStep.expectedHundreds, currentStep.expectedTens, currentStep.expectedOnes];
                        totalExpected = 3;
                    } else if (currentStep.expectedTens !== undefined) {
                        expected = [currentStep.expectedTens, currentStep.expectedOnes];
                        totalExpected = 2;
                    }

                    if (numbers.length >= totalExpected) {
                        // ì…ë ¥ëœ ìˆ«ìì˜ ìˆœì„œëŒ€ë¡œ ê¸°ëŒ€ê°’ê³¼ ë¹„êµ
                        for (let i = 0; i < totalExpected; i++) {
                            if (parseInt(numbers[i]) === expected[i]) {
                                correctCount++;
                            }
                        }
                    }
                    isCorrect = correctCount === totalExpected;
                }
            } else if (currentStep.correctType === 'finalModelCount') {
                // ìµœì¢… ëª«ì„ ëª¨í˜• ê°œìˆ˜ë¡œ í™•ì¸í•˜ëŠ” ë¡œì§ (ë°°ì—´ ë¹„êµ)
                if (numbers) {
                    const userModels = numbers.map(n => parseInt(n));
                    const expectedModels = currentStep.expectedModels;

                    // ìˆœì„œì™€ ê°œìˆ˜ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                    if (userModels.length === expectedModels.length) {
                        isCorrect = userModels.every((val, index) => val === expectedModels[index]);
                    }
                }
            } else if (currentStep.correctType === 'number') {
                // ë‹¨ìˆœ ìˆ«ì í™•ì¸ (ëª«, ì‚¬ìš©í•œ ì´ ê°œìˆ˜, ë³€í™˜ ê°œìˆ˜ ë“±)
                if (numbers && numbers.length > 0) {
                    const numberAnswer = parseInt(numbers[0]);
                    isCorrect = numberAnswer === currentStep.expectedNumber;
                }
            } else if (currentStep.correctType === 'numberOrText') {
                // ìˆ«ì ë˜ëŠ” íŠ¹ì • í…ìŠ¤íŠ¸ í™•ì¸ (ex: ë‚˜ë¨¸ì§€ 0ê°œ ë˜ëŠ” ì—†ì–´ìš”)
                if (numbers && numbers.length > 0) {
                    const numberAnswer = parseInt(numbers[0]);
                    if (numberAnswer === currentStep.expectedNumber) {
                        isCorrect = true;
                    }
                } else if (currentStep.correctText && currentStep.correctText.includes(normalizedAnswer)) {
                    isCorrect = true;
                }
            } 
            // ë‹¤ë¥¸ íƒ€ì…ì˜ ì •ë‹µ ê²€ì‚¬ëŠ” ìƒëµ (í•„ìš”í•œ íƒ€ì…ë§Œ êµ¬í˜„)

            if (isCorrect) {
                removeHintButton(); // ì •ë‹µì„ ë§íˆë©´ íŒíŠ¸ ë²„íŠ¼ ì œê±°
                addUserMessage(answer);
                step++;
                disableInput();
                setTimeout(() => {
                    sendNextMessage();
                }, 1000);
            } else {
                addBotMessage('ë‹¤ì‹œ í•œ ë²ˆ ìƒê°í•´ë³¼ê¹Œìš”?');
                addHintButton(); // í‹€ë ¸ì„ ë•Œ íŒíŠ¸ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
            }
        }

        sendBtn.addEventListener('click', () => {
            const answer = userInput.value;
            if (answer) {
                checkAnswer(answer);
                userInput.value = '';
            }
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        startButton.addEventListener('click', () => {
            // ë‘ ìë¦¬ ìˆ˜ ë¬¸ì œ (10~99) / (2~9)
            const randomDividend = Math.floor(Math.random() * 90) + 10;
            const randomDivisor = Math.floor(Math.random() * 8) + 2;
            addBotMessage(`${randomDividend} Ã· ${randomDivisor} ë¬¸ì œë¥¼ ì‹œì‘í• ê²Œìš”!`);
            startProblem(createScenario(randomDividend, randomDivisor));
        });

        problemStartBtn.addEventListener('click', () => {
            const dividend = parseInt(dividendInput.value);
            const divisor = parseInt(divisorInput.value);

            if (!isNaN(dividend) && !isNaN(divisor) && divisor !== 0) {
                // ë¬¸ì œ ë²”ìœ„ ì œí•œ (10~999 / 2~9)
                if (dividend >= 10 && dividend <= 999 && divisor >= 2 && divisor <= 9) {
                    addBotMessage(`${dividend} Ã· ${divisor} ë¬¸ì œë¥¼ ì‹œì‘í• ê²Œìš”!`);
                    startProblem(createScenario(dividend, divisor));
                } else {
                     addBotMessage('ë‚˜ëˆ„ì–´ì§ˆ ìˆ˜ëŠ” 10ë¶€í„° 999 ì‚¬ì´, ë‚˜ëˆ„ëŠ” ìˆ˜ëŠ” 2ë¶€í„° 9 ì‚¬ì´ì˜ ìì—°ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
            } else {
                addBotMessage('ë‚˜ëˆ„ì–´ì§ˆ ìˆ˜ì™€ ë‚˜ëˆ„ëŠ” ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });

        initApp();
    </script>
</body>
</html>
