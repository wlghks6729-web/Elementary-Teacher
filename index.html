<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나눗셈 친구, 화니쌤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Gowun Dodum', sans-serif;
            background-color: #f0f9ff;
        }
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 1.2rem;
            word-break: keep-all;
            margin-bottom: 8px;
            animation: fadeIn 0.5s ease-in-out;
        }
        .bot-bubble {
            background-color: #ffffff;
            color: #1e293b;
            border-bottom-left-radius: 0.2rem;
            align-self: flex-start;
        }
        .user-bubble {
            background-color: #2563eb;
            color: #ffffff;
            border-bottom-right-radius: 0.2rem;
            align-self: flex-end;
        }
        .llm-hint-bubble {
            background-color: #fef9c3;
            color: #713f12;
            border: 1px solid #fde047;
            align-self: flex-start;
        }
        #chat-window {
            scroll-behavior: smooth;
        }
        
        /* New Grid-based Division Styling */
        .division-grid-container {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: start;
            font-family: 'monospace';
            font-size: 1.5rem;
            line-height: 1.5;
        }
        .divisor-cell {
            padding-right: 0.5rem;
            font-size: 1.8rem;
            padding-top: 2.5rem; /* Pushes divisor down to align with dividend */
        }
        .main-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Max 3 digits for dividend */
        }
        .quotient-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: subgrid;
            color: #2563eb;
            font-weight: bold;
        }
        .dividend-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: subgrid;
            border-top: 2px solid #334155;
            border-left: 2px solid #334155;
        }
        .calculation-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: subgrid;
            /* The long vertical line is removed from here */
        }
        .grid-cell {
            text-align: center;
            padding: 0.25rem;
            min-height: 2.5rem;
        }
        .calculation-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: subgrid;
        }
        .calc-line {
            grid-column: 1 / -1;
            border-top: 2px solid #334155;
            margin: 0.25rem 0;
        }
        .final-remainder {
            color: #c026d3;
            font-weight: bold;
        }

        .llm-hint-button {
            background-color: #fcd34d;
            color: #92400e;
            font-weight: 600;
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .llm-hint-button:hover {
            background-color: #fbbf24;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-sky-100 rounded-2xl shadow-lg p-4 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">나눗셈 친구, 화니쌤</h1>
            <p id="userIdDisplay" class="text-slate-600 mt-2">학습 기록을 불러오는 중...</p>
        </header>
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Chatbot UI -->
            <div class="bg-sky-50 rounded-lg shadow-inner p-4 flex flex-col h-[75vh]">
                <div id="chat-window" class="flex-1 overflow-y-auto pr-2">
                    <!-- Chat messages will appear here -->
                </div>
                <div id="input-container" class="mt-4 flex">
                    <input type="text" id="userInput" class="w-full px-4 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="정답을 입력해 주세요..." disabled>
                    <button id="sendButton" class="bg-blue-600 text-white font-bold px-6 py-2 rounded-r-lg hover:bg-blue-700 disabled:bg-gray-400">전송</button>
                </div>
            </div>
            <!-- Division Visualization -->
            <div class="flex flex-col items-center justify-start bg-white rounded-lg shadow-inner p-4 pt-8 h-[75vh]">
                 <div id="division-container" class="division-grid-container hidden">
                    <div id="divisor-area" class="divisor-cell"></div>
                    <div id="main-grid" class="main-grid">
                        <div id="quotient-grid" class="quotient-grid"></div>
                        <div id="dividend-grid" class="dividend-grid"></div>
                        <div id="calculation-grid" class="calculation-grid"></div>
                    </div>
                </div>
                <div id="start-screen" class="text-center">
                    <img src="https://placehold.co/150x150/e0f2fe/0c4a6e?text=%C3%B7" alt="나눗셈 기호" class="mx-auto rounded-full mb-4">
                    <div id="problem-input-area" class="flex flex-col gap-4 w-full">
                        <p class="text-slate-700 text-lg">어떤 나눗셈을 풀어볼까요?</p>
                        <div class="flex gap-4 justify-center items-start">
                            <!-- Dividend Input -->
                            <div class="flex flex-col items-center">
                                <label for="dividendInput" class="text-slate-600 mb-1">나누어질 수</label>
                                <div class="flex items-center">
                                    <button id="dividend-decrement" class="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 text-gray-700 font-bold p-2 rounded-l-md w-10">-</button>
                                    <input type="number" id="dividendInput" class="w-24 p-2 border-t border-b text-center focus:outline-none" min="0">
                                    <button id="dividend-increment" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-r-md w-10">+</button>
                                </div>
                            </div>
                            <span class="text-2xl font-bold pt-8">÷</span>
                            <!-- Divisor Input -->
                            <div class="flex flex-col items-center">
                                <label for="divisorInput" class="text-slate-600 mb-1">나누는 수</label>
                                <div class="flex items-center">
                                    <button id="divisor-decrement" class="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 disabled:text-gray-400 text-gray-700 font-bold p-2 rounded-l-md w-10">-</button>
                                    <input type="number" id="divisorInput" class="w-24 p-2 border-t border-b text-center focus:outline-none" min="0">
                                    <button id="divisor-increment" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-2 rounded-r-md w-10">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 mt-2">
                             <button id="problemStartBtn" class="bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600">직접 문제내기</button>
                             <button id="randomStartButton" class="bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600">랜덤 문제 시작!</button>
                        </div>
                    </div>
                </div>
                <div id="completion-area" class="hidden">
                    <button id="resetButton" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800 mt-4">처음으로</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let currentProblem = null;
        let step = 0;
        let isLlmGenerating = false;
        let isFirebaseReady = false;
        let visualState = {};

        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const startScreen = document.getElementById('start-screen');
        const problemInputArea = document.getElementById('problem-input-area');
        const completionArea = document.getElementById('completion-area');
        
        const divisionContainer = document.getElementById('division-container');
        const divisorArea = document.getElementById('divisor-area');
        const mainGrid = document.getElementById('main-grid');
        const quotientGrid = document.getElementById('quotient-grid');
        const dividendGrid = document.getElementById('dividend-grid');
        const calculationGrid = document.getElementById('calculation-grid');

        const problemStartBtn = document.getElementById('problemStartBtn');
        const randomStartButton = document.getElementById('randomStartButton');
        const resetButton = document.getElementById('resetButton');
        const dividendInput = document.getElementById('dividendInput');
        const divisorInput = document.getElementById('divisorInput');
        const userIdDisplay = document.getElementById('userIdDisplay');
        
        const dividendDecrement = document.getElementById('dividend-decrement');
        const dividendIncrement = document.getElementById('dividend-increment');
        const divisorDecrement = document.getElementById('divisor-decrement');
        const divisorIncrement = document.getElementById('divisor-increment');


        const apiKey = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        async function fetchWithExponentialBackoff(payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function generateHint(currentProblem, currentStep) {
            if (isLlmGenerating) return;
            isLlmGenerating = true;
            const problem = `${currentProblem.dividend} ÷ ${currentProblem.divisor}`;
            const question = currentProblem.steps[step].text;
            const systemPrompt = `당신은 초등학생에게 나눗셈을 가르치는 친절하고 격려하는 수학 튜터(화니쌤)입니다. 학생이 틀린 문제의 단계를 보고, 정답을 직접 알려주지 않고, 다음 질문에 대한 답을 찾는 데 도움이 될 수 있는 구체적인 힌트를 한 문장으로 제공하세요. 힌트는 수 모형(백모형, 십모형, 일모형)의 개념을 사용하여 설명해야 합니다. 답변은 반드시 한국어로 작성하세요.`;
            const userQuery = `현재 문제: ${problem}. 바로 이전 챗봇의 질문: "${question}". 이 질문에 대한 힌트를 1개의 구체적인 문장으로 생성해 주세요.`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            addBotMessage('<div id="llm-hint-loading" class="text-sm text-gray-500 italic">✨ 화니쌤 팁을 생각 중...</div>', 'bot-bubble');
            const loadingElement = document.getElementById('llm-hint-loading');
            try {
                const result = await fetchWithExponentialBackoff(payload);
                const hintText = result.candidates?.[0]?.content?.parts?.[0]?.text || "잠시 오류가 발생했어요. 다시 시도해 볼까요?";
                if (loadingElement) {
                    loadingElement.parentElement.classList.remove('bot-bubble');
                    loadingElement.parentElement.classList.add('llm-hint-bubble');
                    loadingElement.innerHTML = `✨ <b>화니쌤 팁:</b> ${hintText}`;
                    scrollToBottom();
                }
            } catch (error) {
                if (loadingElement) loadingElement.textContent = "힌트 생성에 실패했어요. 하지만 괜찮아요! 다시 시도해봐요!";
            } finally {
                isLlmGenerating = false;
            }
        }

        async function generateFinalComment(dividend, divisor, quotient, remainder) {
            const systemPrompt = `당신은 초등학생에게 나눗셈을 가르치는 친절하고 유머러스한 수학 튜터(화니쌤)입니다. 학생이 푼 나눗셈 문제의 결과와 특징을 바탕으로, 칭찬과 격려를 담은 1~2문장의 최종 피드백을 한국어로 생성해주세요.`;
            const userQuery = `학생이 나눗셈 문제 ${dividend} ÷ ${divisor}를 풀었습니다. 몫은 ${quotient}이고 나머지는 ${remainder}입니다. 이 결과를 바탕으로 학생의 노력에 대해 칭찬하고 격려하는 최종 코멘트를 작성해 주세요.`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
            try {
                const result = await fetchWithExponentialBackoff(payload);
                const commentText = result.candidates?.[0]?.content?.parts?.[0]?.text || "수고했어요! 정말 멋진 학습 태도예요!";
                addBotMessage(`<div class="font-bold text-indigo-700">🎉 ✨ 화니쌤 코멘트:</div><div>${commentText}</div>`);
            } catch (error) {
                addBotMessage('수고했어요! 정말 멋진 학습 태도예요!');
            }
        }

        function createScenario(dividend, divisor) {
            const scenario = [];
            const dividendStr = String(dividend);
            const finalQuotient = Math.floor(dividend / divisor);
            const finalRemainder = dividend % divisor;

            if (dividend >= 100) {
                const hundreds = Math.floor(dividend / 100);
                const tens = Math.floor((dividend % 100) / 10);
                const ones = dividend % 10;
                
                scenario.push({ type: 'bot', text: `안녕! 나는 나눗셈을 도와주는 화니쌤이야. 함께 ${dividend} ÷ ${divisor}를 풀어볼까? 먼저 ${dividend}은/는 백모형 ${hundreds}개, 십모형 ${tens}개, 일모형 ${ones}개로 나타낼 수 있어.` });
                
                let quotientHundreds = 0;
                let remainderHundreds = 0;
                let totalTens = 0;

                if (hundreds >= divisor) {
                    quotientHundreds = Math.floor(hundreds / divisor);
                    remainderHundreds = hundreds % divisor;

                    scenario.push({ type: 'bot', text: `가장 큰 수 모형인 백모형 ${hundreds}개를 ${divisor}명에게 똑같이 나누어 주면 한 명당 몇 개씩 가질 수 있을까?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientHundreds, visual: { type: 'quotient', value: quotientHundreds, index: 0 } });
                    
                    scenario.push({ type: 'bot', text: `딩동댕! 그럼 ${divisor}명에게 백모형을 ${quotientHundreds}개씩 나누어주면, 사용한 백모형은 모두 몇 개일까? (${divisor} × ${quotientHundreds})` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientHundreds * divisor, visual: { type: 'subtraction', value: quotientHundreds * divisor, index: 0 } });
                    
                    scenario.push({ type: 'bot', text: `맞아! 그럼 남는 백모형은 몇 개일까?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: remainderHundreds, visual: { type: 'remainder', value: remainderHundreds, index: 0 } });

                    totalTens = remainderHundreds * 10 + tens;
                    
                    if (remainderHundreds > 0) {
                        scenario.push({ type: 'bot', text: `남은 백모형 ${remainderHundreds}개는 십모형으로 바꿔주자. 백모형 ${remainderHundreds}개는 십모형 ${remainderHundreds*10}개가 돼. 원래 있던 십모형 ${tens}개와 합치면, 십모형은 모두 몇 개가 될까?` });
                        scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalTens, visual: { type: 'bring_down', value: tens, index: 1 }});
                    } else {
                         scenario.push({ type: 'bot', text: `남는 백모형이 없네! 그럼 원래 있던 십모형은 몇 개인가요?`});
                         scenario.push({ type: 'user', correctType: 'number', expectedNumber: tens, visual: { type: 'bring_down', value: tens, index: 1 }});
                         totalTens = tens;
                    }
                } else {
                    scenario.push({ type: 'bot', text: `백모형 ${hundreds}개를 ${divisor}명에게 몇 개씩 나눠줄 수 있나요?` });
                    scenario.push({ type: 'user', correctType: 'numberOrText', expectedNumber: 0, expectedTexts: ['없어요', '아니오', '0개', '0'], visual: { type: 'quotient', value: 0, index: 0 } });

                    totalTens = hundreds * 10 + tens;
                    scenario.push({ type: 'bot', text: `맞아! 백모형은 똑같이 나눠줄 수 없으니 몫의 백의 자리엔 0을 써주고, 남은 백모형 ${hundreds}개를 십모형 ${hundreds*10}개로 바꾸자. 원래 있던 십모형 ${tens}개와 합하면 총 몇 개인가요?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalTens });
                }
                
                const quotientTens = Math.floor(totalTens / divisor);
                const remainderTens = totalTens % divisor;

                scenario.push({ type: 'bot', text: `십모형 ${totalTens}개를 ${divisor}명에게 똑같이 나누어 주면 한 명당 몇 개씩 가질 수 있을까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens, visual: { type: 'quotient', value: quotientTens, index: 1 } });

                scenario.push({ type: 'bot', text: `딩동댕! 그럼 사용한 십모형은 모두 몇 개일까? (${divisor} × ${quotientTens})` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens * divisor, visual: { type: 'subtraction', value: quotientTens * divisor, index: 1 } });
            
                scenario.push({ type: 'bot', text: `잘했어! 그럼 남는 십모형은 몇 개일까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: remainderTens, visual: { type: 'remainder', value: remainderTens, index: 1 } });
                
                const totalOnes = remainderTens * 10 + ones;
                
                if (remainderTens > 0) {
                     scenario.push({ type: 'bot', text: `남은 십모형 ${remainderTens}개는 일모형 ${remainderTens*10}개로 바꿀 수 있어. 원래 있던 ${ones}개와 합치면 일모형은 모두 몇 개일까?` });
                     scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalOnes, visual: { type: 'bring_down', value: ones, index: 2 }});
                } else { 
                     scenario.push({ type: 'bot', text: `남은 십모형이 없네! 그럼 원래 있던 일모형은 몇 개인가요?`});
                     scenario.push({ type: 'user', correctType: 'number', expectedNumber: ones, visual: { type: 'bring_down', value: ones, index: 2 }});
                }
                
                const quotientOnes = Math.floor(totalOnes / divisor);
                const remainderOnes = totalOnes % divisor;

                scenario.push({ type: 'bot', text: `완벽해! 이제 일모형 ${totalOnes}개를 ${divisor}명에게 똑같이 나누어 주면 한 명당 몇 개씩 가지게 될까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes, visual: { type: 'quotient', value: quotientOnes, index: 2 } });
                
                scenario.push({ type: 'bot', text: `대단해! 그럼 사용한 일모형은 모두 몇 개일까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes * divisor, visual: { type: 'subtraction', value: quotientOnes * divisor, index: 2 } });

                scenario.push({ type: 'bot', text: `맞아. 그럼 남는 일모형은 몇 개일까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: remainderOnes, visual: { type: 'remainder', value: remainderOnes, index: 2, isFinal: true } });

            } else {
                const tens = Math.floor(dividend / 10);
                const ones = dividend % 10;
                scenario.push({ type: 'bot', text: `안녕! 나는 나눗셈을 도와주는 화니쌤이야. 함께 ${dividend} ÷ ${divisor}를 풀어볼까? 먼저 ${dividend}은/는 십모형 ${tens}개와 일모형 ${ones}개로 나타낼 수 있어.` });
                
                const quotientTens = Math.floor(tens / divisor);
                const remainderTens = tens % divisor;

                scenario.push({ type: 'bot', text: `먼저 십모형 ${tens}개를 ${divisor}명에게 똑같이 나누어 주면 한 명당 몇 개씩 가질 수 있을까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens, visual: { type: 'quotient', value: quotientTens, index: 0 } });

                if (quotientTens >= 0) {
                    scenario.push({ type: 'bot', text: `딩동댕! 그럼 ${divisor}명에게 십모형을 ${quotientTens}개씩 나누어주면, 사용한 십모형은 모두 몇 개일까? (${divisor} × ${quotientTens})` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientTens * divisor, visual: { type: 'subtraction', value: quotientTens * divisor, index: 0 } });
                }

                scenario.push({ type: 'bot', text: `아주 잘했어! 그럼 남는 십모형은 몇 개일까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: remainderTens, visual: { type: 'remainder', value: remainderTens, index: 0 } });

                const totalOnes = remainderTens * 10 + ones;

                if(remainderTens > 0) {
                    scenario.push({ type: 'bot', text: `남은 십모형 ${remainderTens}개는 일모형으로 바꿔주자. 십모형 ${remainderTens}개는 일모형 ${remainderTens*10}개와 같아. 원래 있던 일모형 ${ones}개와 합치면, 일모형은 모두 몇 개가 될까?` });
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: totalOnes, visual: { type: 'bring_down', value: ones, index: 1 }});
                } else {
                    scenario.push({ type: 'bot', text: `남은 십모형이 없네! 그럼 원래 있던 일모형은 몇 개인가요?`});
                    scenario.push({ type: 'user', correctType: 'number', expectedNumber: ones, visual: { type: 'bring_down', value: ones, index: 1 }});
                }
                
                const quotientOnes = Math.floor(totalOnes / divisor);
                const remainderOnes = totalOnes % divisor;
                
                scenario.push({ type: 'bot', text: `완벽해! 이제 일모형 ${totalOnes}개를 ${divisor}명에게 똑같이 나누어 주면 한 명당 몇 개씩 가지게 될까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes, visual: { type: 'quotient', value: quotientOnes, index: 1 } });
                
                scenario.push({ type: 'bot', text: `대단해! 그럼 사용한 일모형은 모두 몇 개일까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: quotientOnes * divisor, visual: { type: 'subtraction', value: quotientOnes * divisor, index: 1 } });

                scenario.push({ type: 'bot', text: `맞아. 그럼 남는 일모형은 몇 개일까?` });
                scenario.push({ type: 'user', correctType: 'number', expectedNumber: remainderOnes, visual: { type: 'remainder', value: remainderOnes, index: 1, isFinal: true } });
            }
            
            scenario.push({ type: 'bot', text: '좋아요, 이제 나눗셈 결과를 정리해봅시다. 몫은 얼마인가요?' });
            scenario.push({ type: 'user', correctType: 'number', expectedNumber: finalQuotient });
            scenario.push({ type: 'bot', text: '훌륭해요. 나머지는 얼마인가요?' });
            scenario.push({ type: 'user', correctType: 'number', expectedNumber: finalRemainder });

            return { dividend, divisor, quotient: finalQuotient, remainder: finalRemainder, steps: scenario };
        }

        function setupDivisionVisual(dividend, divisor) {
            startScreen.classList.add('hidden');
            divisionContainer.classList.remove('hidden');
            
            divisorArea.textContent = divisor;
            const dividendStr = String(dividend);
            const numCols = dividendStr.length;
            mainGrid.style.gridTemplateColumns = `repeat(${numCols}, 1fr)`;

            quotientGrid.innerHTML = '';
            dividendGrid.innerHTML = '';
            calculationGrid.innerHTML = '';

            const quotientStr = String(Math.floor(dividend / divisor));
            const paddingCount = dividendStr.length - quotientStr.length;
            
            visualState = {
                dividendStr: dividendStr,
                stepHistory: [],
                quotientPaddingCount: paddingCount,
                currentRow: 0,
            };
            
            for(let i=0; i < numCols; i++) {
                const qCell = document.createElement('div');
                qCell.className = 'grid-cell quotient-cell';
                qCell.id = `q-cell-${i}`;
                quotientGrid.appendChild(qCell);

                const dCell = document.createElement('div');
                dCell.className = 'grid-cell';
                dCell.textContent = dividendStr[i];
                dividendGrid.appendChild(dCell);
            }
        }

        function updateDivisionVisual(visualInfo) {
            const { type, value, index, isFinal } = visualInfo;
            const numCols = visualState.dividendStr.length;

            if (type === 'quotient') {
                const finalQuotientStr = String(currentProblem.quotient);
                let quotientPadding = visualState.dividendStr.length - finalQuotientStr.length;
                
                let currentDivisor = parseInt(visualState.dividendStr.substring(0, index + 1));
                if(index === 0 && value === 0){
                    quotientPadding = 0;
                } else if(finalQuotientStr.length < visualState.dividendStr.length && parseInt(visualState.dividendStr[0]) < currentProblem.divisor) {
                    quotientPadding = 0;
                }


                const quotientCell = document.getElementById(`q-cell-${index + quotientPadding}`);
                if (quotientCell) {
                    quotientCell.textContent = value;
                }

            } else if (type === 'subtraction') {
                const row = document.createElement('div');
                row.className = 'calculation-row';
                const valueStr = String(value);
                
                const padding = index - valueStr.length + 1;
                for(let i = 0; i < numCols; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    if (i >= padding && i < padding + valueStr.length) {
                        cell.textContent = valueStr[i - padding];
                    }
                    row.appendChild(cell);
                }
                calculationGrid.appendChild(row);

            } else if (type === 'remainder') {
                const line = document.createElement('div');
                line.className = 'calc-line';
                calculationGrid.appendChild(line);

                const row = document.createElement('div');
                row.className = 'calculation-row';
                const valueStr = String(value);
                const padding = index - valueStr.length + 1;

                for(let i = 0; i < numCols; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    if (i >= padding && i < padding + valueStr.length) {
                        cell.textContent = valueStr[i - padding];
                    }
                    if(isFinal) cell.classList.add('final-remainder');
                    row.appendChild(cell);
                }
                calculationGrid.appendChild(row);

            } else if (type === 'bring_down') {
                const lastRow = calculationGrid.lastChild;
                if(lastRow) {
                    const cellToUpdate = lastRow.children[index];
                    if(cellToUpdate) {
                       if (cellToUpdate.textContent.trim() !== "" && !(cellToUpdate.textContent.trim() === "0" && value > 0)) {
                           cellToUpdate.textContent += String(value);
                       } else {
                           cellToUpdate.textContent = value;
                       }
                    }
                }
            }
            visualState.stepHistory.push(visualInfo);
        }
        
        async function initApp() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                userIdDisplay.textContent = '상태: 기록 저장 불가 (오프라인 모드)';
                isFirebaseReady = false;
                showStartScreen();
                return; 
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseReady = true;
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `사용자 ID: ${userId.substring(0, 8)}... (학습 내용 자동 저장)`;
                        await loadChatState();
                    } else {
                        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                userIdDisplay.textContent = '상태: 기록 저장 불가 (초기화 오류)';
                isFirebaseReady = false;
                showStartScreen();
            }
        }

        async function saveChatState() {
            if (!isFirebaseReady || !userId) return;
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/chatState/state`);
            try {
                const visualData = {
                    quotient: quotientGrid.innerHTML,
                    dividend: dividendGrid.innerHTML,
                    calculation: calculationGrid.innerHTML,
                    history: visualState.stepHistory 
                }
                await setDoc(userDocRef, { currentProblem, step, messages: chatWindow.innerHTML, visualData });
            } catch (error) { console.error("Save state failed:", error); }
        }

        async function loadChatState() {
            if (!isFirebaseReady || !userId) {
                addBotMessage(`안녕하세요! 나눗셈 친구, 화니쌤이에요. 함께 재미있는 나눗셈 공부를 시작해볼까요?`);
                showStartScreen();
                return;
            }
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/chatState/state`);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists() && docSnap.data().currentProblem) {
                    const data = docSnap.data();
                    currentProblem = data.currentProblem;
                    step = data.step;
                    chatWindow.innerHTML = data.messages;
                    scrollToBottom();
                    
                    if (currentProblem) {
                        setupDivisionVisual(currentProblem.dividend, currentProblem.divisor);
                        if (data.visualData) {
                            quotientGrid.innerHTML = data.visualData.quotient;
                            dividendGrid.innerHTML = data.visualData.dividend;
                            calculationGrid.innerHTML = data.visualData.calculation;
                            visualState.stepHistory = data.visualData.history;
                        }
                    }

                    if (currentProblem && step < currentProblem.steps.length) {
                        startProblem(currentProblem, false, true); 
                    } else if (currentProblem) {
                        showCompletionScreen();
                    } else {
                        showStartScreen();
                    }
                } else {
                    addBotMessage(`안녕하세요! 나눗셈 친구, 화니쌤이에요. 함께 재미있는 나눗셈 공부를 시작해볼까요?`);
                    showStartScreen();
                }
            } catch (error) {
                console.error("Load state failed:", error);
                addBotMessage('이전 학습 기록을 불러오는 데 실패했어요. 새로운 학습을 시작해볼까요?');
                showStartScreen();
            }
        }

        function addBotMessage(text, className = 'bot-bubble') {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-bubble ${className}`;
            msgDiv.innerHTML = text;
            chatWindow.appendChild(msgDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-bubble user-bubble';
            msgDiv.textContent = text;
            chatWindow.appendChild(msgDiv);
            scrollToBottom();
        }
        function scrollToBottom() { chatWindow.scrollTop = chatWindow.scrollHeight; }
        function enableInput() { userInput.disabled = false; sendButton.disabled = false; userInput.focus(); }
        function disableInput() { userInput.disabled = true; sendButton.disabled = true; }
        
        function showStartScreen() {
            disableInput();
            divisionContainer.classList.add('hidden');
            startScreen.classList.remove('hidden');
            completionArea.classList.add('hidden');
            problemInputArea.classList.remove('hidden');
            dividendInput.value = '';
            divisorInput.value = '';
            updateDecrementButtons();
        }
        function showCompletionScreen() {
            disableInput();
            completionArea.classList.remove('hidden');
        }
        function startProblem(problem, resetChat = true, isContinuing = false) {
            completionArea.classList.add('hidden');
            if(!isContinuing) {
                 if(resetChat) chatWindow.innerHTML = '';
                 step = 0;
                 setupDivisionVisual(problem.dividend, problem.divisor);
            }
            currentProblem = problem;
            sendNextMessage();
        }
        function sendNextMessage() {
            if (!currentProblem || step >= currentProblem.steps.length) {
                if (currentProblem) {
                    generateFinalComment(currentProblem.dividend, currentProblem.divisor, currentProblem.quotient, currentProblem.remainder);
                }
                addBotMessage('모든 문제를 다 풀었어요! 다른 문제를 풀어보려면 "처음으로" 버튼을 눌러주세요.');
                showCompletionScreen();
                saveChatState();
                return;
            }
            const currentStep = currentProblem.steps[step];
            
            if (currentStep.type === 'bot') {
                addBotMessage(currentStep.text);
                if (currentStep.visual) { 
                    updateDivisionVisual(currentStep.visual);
                }
                step++;
                setTimeout(() => sendNextMessage(), 800); 
            } else {
                addHintButton();
                enableInput();
                saveChatState();
            }
        }
        function addHintButton() {
            if (document.getElementById('llmHintButton')) return; 
            const btn = document.createElement('button');
            btn.id = 'llmHintButton';
            btn.className = 'llm-hint-button';
            btn.textContent = '✨ 화니쌤 팁 받기';
            btn.onclick = () => {
                const currentStep = currentProblem.steps[step];
                generateHint(currentProblem, currentStep);
                btn.disabled = true;
                setTimeout(() => { btn.disabled = false; }, 5000);
            };
            const lastMessage = chatWindow.lastElementChild;
            if (lastMessage && lastMessage.classList.contains('bot-bubble')) {
                lastMessage.appendChild(document.createElement('br'));
                lastMessage.appendChild(btn);
            }
        }
        
        function removeHintButton() {
            const btn = document.getElementById('llmHintButton');
            if (btn) btn.remove();
        }
        function checkAnswer(answer) {
            if (!currentProblem || step >= currentProblem.steps.length) return;
            
            const currentStep = currentProblem.steps[step];
            if (currentStep.type === 'bot') { step++; sendNextMessage(); return; }
            
            let isCorrect = false;
            const normalizedAnswer = answer.toLowerCase().trim();
            
            if (currentStep.correctType === 'number') {
                const numbers = normalizedAnswer.match(/\d+/g);
                const numberAnswer = numbers ? parseInt(numbers[0]) : NaN;
                if (numberAnswer === currentStep.expectedNumber) isCorrect = true;
            } else if (currentStep.correctType === 'numberOrText') {
                const numbers = normalizedAnswer.match(/\d+/g);
                const numberAnswer = numbers ? parseInt(numbers[0]) : NaN;
                if (numberAnswer === currentStep.expectedNumber || 
                   (currentStep.expectedTexts && currentStep.expectedTexts.includes(normalizedAnswer)) ) {
                    isCorrect = true;
                }
            }
            
            if (isCorrect) {
                removeHintButton();
                addUserMessage(answer);
                
                if (currentStep.visual) {
                    updateDivisionVisual(currentStep.visual);
                }
                step++;
                disableInput();
                if (step >= currentProblem.steps.length) {
                    sendNextMessage(); // 마지막 단계 후 즉시 피드백
                } else {
                    setTimeout(sendNextMessage, 1000); // 중간 단계는 딜레이 유지
                }
            } else {
                addBotMessage('음... 다시 한 번 생각해볼까요?');
            }
        }
        sendButton.addEventListener('click', () => {
            const answer = userInput.value;
            if (answer) { checkAnswer(answer); userInput.value = ''; }
        });
        userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendButton.click(); });
        
        randomStartButton.addEventListener('click', () => {
            const randomDividend = Math.floor(Math.random() * 900) + 10;
            const randomDivisor = Math.floor(Math.random() * 8) + 2;
            startProblem(createScenario(randomDividend, randomDivisor));
        });
        problemStartBtn.addEventListener('click', () => {
            const dividend = parseInt(dividendInput.value);
            const divisor = parseInt(divisorInput.value);
            
            if (!isNaN(dividend) && !isNaN(divisor) && divisor > 0) {
                if (dividend >= 10 && dividend <= 999 && divisor >= 2 && divisor <= 9) {
                    startProblem(createScenario(dividend, divisor));
                } else {
                    addBotMessage('나누어질 수는 10부터 999 사이, 나누는 수는 2부터 9 사이의 자연수를 입력해주세요.');
                }
            } else {
                addBotMessage('나누어질 수와 나누는 수를 올바르게 입력해주세요.');
            }
        });
        
        resetButton.addEventListener('click', showStartScreen);

        function updateDecrementButtons() {
            const dividendValue = parseInt(dividendInput.value) || 0;
            const divisorValue = parseInt(divisorInput.value) || 0;
            dividendDecrement.disabled = dividendValue <= 0;
            divisorDecrement.disabled = divisorValue <= 0;
        }

        dividendIncrement.addEventListener('click', () => {
            dividendInput.value = (parseInt(dividendInput.value) || 0) + 1;
            updateDecrementButtons();
        });

        dividendDecrement.addEventListener('click', () => {
            const value = (parseInt(dividendInput.value) || 0);
            if (value > 0) {
                dividendInput.value = value - 1;
            }
            updateDecrementButtons();
        });

        divisorIncrement.addEventListener('click', () => {
            divisorInput.value = (parseInt(divisorInput.value) || 0) + 1;
            updateDecrementButtons();
        });

        divisorDecrement.addEventListener('click', () => {
            const value = (parseInt(divisorInput.value) || 0);
            if (value > 0) {
                divisorInput.value = value - 1;
            }
            updateDecrementButtons();
        });

        dividendInput.addEventListener('input', updateDecrementButtons);
        divisorInput.addEventListener('input', updateDecrementButtons);
        
        initApp();
    </script>
</body>
</html>

